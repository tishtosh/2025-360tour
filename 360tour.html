<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>360 tours</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gallery-plugin/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/compass-plugin@5.12.1/index.min.css">

    <style>
        .ios-button {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #007aff;
            background-color: #ffffff;
            border: 1px solid #007aff;
            border-radius: 12px;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
            margin: 5px; /* Add margin to space the buttons */
        }
    
        .ios-button:hover {
            background-color: #f0f0f5;
        }
    
        .ios-button:active {
            background-color: #e0e0eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        </style>
        <style>
            .inputfile {
                width: 100.1px;
                height: 20.1px;
                opacity: 10;
                overflow: hidden;
                position: absolute;
                z-index: -1;
            }

            .inputfile + label {
                font-size: 1.25em;
                font-weight: 700;
                color: white;
                background-color: black;
                display: inline-block;
            }

            .inputfile:focus + label,
            .inputfile + label:hover {
                background-color: red;
            }

            html {
                font-family: sans-serif;
            }

            .custom-tooltip {
                max-width: none;
                width: 300px;
                box-shadow: 0 0 0 3px white;
            }

            .custom-tooltip .psv-tooltip-content {
                padding: 0;
            }

            .custom-tooltip img {
                width: 100%;
                border-radius: 4px 4px 0 0;
            }

            .custom-tooltip h2,
            .custom-tooltip p {
                margin: 1rem;
                text-align: justify;
            }

        </style> 
</head>

<body>
    <!-- the viewer container must have a defined size -->
    <div id="viewer" style="width: 98vw; height: 85vh;"></div>
    
    <script type="importmap">
        {
            "imports": {            
                "three" : "https://cdn.jsdelivr.net/npm/three/build/three.module.min.js",
                "@photo-sphere-viewer/core" : "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5.12.0/index.module.min.js",
                "@photo-sphere-viewer/markers-plugin" : "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5.12.0/index.module.min.js",
                "@photo-sphere-viewer/gallery-plugin" : "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gallery-plugin@5.12.0/index.module.min.js",
                "@photo-sphere-viewer/virtual-tour-plugin" : "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin@5.12.0/index.module.min.js",
                "@photo-sphere-viewer/compass-plugin" : "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/compass-plugin@5.12.0/index.module.min.js"
            }
        }
    </script>


    <script type="module">
        // use  exiftool -XMP-GPano:PoseHeadingDegrees="290.0" 162430.jpg 
        
        import { Viewer } from '@photo-sphere-viewer/core';
        import { MarkersPlugin } from 'https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5.12.0/index.module.min.js';
        import { GalleryPlugin } from 'https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gallery-plugin@5.12.0/index.module.min.js';
        import { VirtualTourPlugin } from 'https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin@5.12.0/index.module.min.js';
        import { CompassPlugin } from 'https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/compass-plugin@5.12.0/index.module.min.js';
        
        const baseUrl = 'https://photo-sphere-viewer-data.netlify.app/assets/';
        const pageCaption = 'Greenlands Drive';

        const getGPS = ( feetx, feety, feetz ) => {
            const feetToMeters = (feet) => feet * 0.3048;
            const inchesToMeters = (inches) => inches * 0.0254;
    
            // Base GPS position (longitude, latitude, altitude in meters)
            return [ 50.944905+ feetToMeters(feetx), -0.127910 + feetToMeters(feety), feetToMeters(feetz) ];
        };

        const getNode3 = ( nodeid, image  ) => {
            return {
                id: nodeid,
                panorama: image,
                thumbnail: image,
                name: nodeid,
                caption: nodeid,
                links: [],
                gps:  getGPS( 0, 0, -4 ),
                sphereCorrection: { pan:0, tilt:0, roll:0 },
            };
        }

        // Load photos and click nodes from JSON file 
        async function loadConfigDataFromUrl(configDataUrl) {
            fetch(configDataUrl)
            .then(response => 
                response.json()
            )
            .then(loadedConfigData => {
                configData.length = 0; // Clear the existing configData
                Array.prototype.push.apply(configData, loadedConfigData);
                console.log("Config data loaded successfully from URL:", configData);
                nodeData = [ 
                    configData[0].nodes.map(location => getNode3(location.id, location.image)),
                    configData[1].nodes.map(location => getNode3(location.id, location.image)),
                    configData[2].nodes.map(location => getNode3(location.id, location.image))
                ];
                if( configData[0].nodes.length > 0 ) {
                    floorHotspots = configData[0].hotspots;
                    virtualTourPlugin.setNodes( nodeData[0] );            
                }
            })
            .catch(error => {
                const e = "Error loading configuration.\n" + error.name + "\n" + error.message;
                console.error( e );
                alert( e );
            });
        }
        
        //Format of the JSON file
        //const configData = [
        //    { id: "Garden", nodes: floorGarden, hotspots: floorGarden_hotspots },
        //    { id: "First", nodes: floorFirst, hotspots: floorFirst_hotspots },
        //    { id: "Second", nodes: floorSecond, hotspots: floorSecond_hotspots }
        //];    

        // Configuration data for each floor
        let  configData = [ ];
        let  nodeData = [ ];
        
        // Selected floor
        var floorHotspots = []  

        // New marker identifier until renamed
        var newMarkerId = 100;
        
        // Create an input element for file selection
        const fileinputElement = document.createElement('input');
        fileinputElement.type = 'file';
        fileinputElement.accept = '.json';

        // Add an event listener to handle file selection for upload 
        fileinputElement.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                loadConfigDataFromUrl( fileURL );
            }
        });

        // Main 360 viewer
        const viewer = new Viewer({
            container: document.querySelector('#viewer'),
            panorama: `image1.jpg`,
            caption: pageCaption,

            navbar: [
                'zoom',
                'gallery',
                {
                    id: 'fileload',
                    content: "<button id='load'>Load</button>",
                    title: 'load',
                    className: 'custom-button',
                    onClick(viewer) {
                        fileinputElement.click();
                    },
                },
                {
                    id: 'save',
                    content: "<button id='save'>Save</button>",
                    title: 'Save',
                    className: 'custom-button',
                    onClick(viewer) {
                        saveConfigData();
                    },
                },
               
                {
                      id: 'floorDescription',
                        content: "Choose a floor", 
                        title: 'choose',
                        className: 'custom-button',
                },
                // TODO fix to dynamically define based on loaded json floors
                {
                    id: 'floorGarden',
                    content: "Garden", // configData[0].id,
                    title: "Garden",
                    className: 'custom-button',
                    onClick(viewer) {
                        if( configData[0].nodes.length > 0 ) {
                            floorHotspots = configData[0].hotspots;
                            virtualTourPlugin.setNodes( nodeData[0] );            
                        }
                    },
                },
                {
                    id: 'floorFirst',
                    content: "First",   // configData[1].id,
                    title: "First",
                    className: 'custom-button',
                    onClick(viewer) {
                        if( configData[1].nodes.length > 0 ) {
                            floorHotspots = configData[1].hotspots;
                            virtualTourPlugin.setNodes( nodeData[1] );  
                        }
                   },
                },
                {
                    id: 'floorSecond',
                    content: "Second", // configData[2].id,
                    title: "Second",
                    className: 'custom-button',
                    onClick(viewer) {
                        if( configData[2].nodes.length > 0 ) {
                            floorHotspots = configData[2].hotspots;
                            virtualTourPlugin.setNodes( nodeData[2] );
                        }
                    },
                },
                'caption',
                'description',
                'fullscreen',
            ],

            plugins: [
                [MarkersPlugin, {} ],
                [GalleryPlugin, {}],
                [CompassPlugin, {
                    hotspots: [
                        { yaw: '0deg' },
                        { yaw: '90deg' },
                        { yaw: '180deg' },
                        { yaw: '270deg' },
                    ],
                }],
                [VirtualTourPlugin, {
                    positionMode: 'gps',
                    renderMode: '3d',
                }]
            ],
        });

        // Remember the markers and tour plugins
        const markersPlugin = viewer.getPlugin(MarkersPlugin);
        markersPlugin.setOptions({
            clickEventOnMarker: true,
        });

        const virtualTourPlugin = viewer.getPlugin(VirtualTourPlugin);

        // Load default configuration of photos and click nodes
        //const configDataUrl = 'greenlands.json';
        const configDataUrl = 'greenlands-short.json';
        await loadConfigDataFromUrl(configDataUrl);

        // Reload new markers when the node (the picture being displayed) changes
        virtualTourPlugin.addEventListener('node-changed', ({ node }) => {
            
            // Reload dynamic tooltip to be all possible nodes
            const tooltipHTML = loadNodeTooltip() 
    
            // Change to the marker's nodes 
            markersPlugin.clearMarkers();       
            floorHotspots.forEach(hotspot => {
                if (hotspot.node === node.id) {
                    markersPlugin.addMarker({
                        id: '#' + Math.random(),
                        position: { yaw: hotspot.yaw, pitch: hotspot.pitch },
                        image: baseUrl + 'pictos/pin-blue.png',     //  'pictos/target.png',
                        size: { width: 64, height: 64 },
                        anchor: 'center center',
                        tooltip: tooltipHTML,   //tooltip: `${hotspot.targetNode}`,
                        data: {
                            generated: true,
                            targetNode: hotspot.targetNode,
                        },
                    });
                }
            });
        });

        // Add view event listener to output all events to the console
        viewer.addEventListener('view', (event) => {
            console.log('View event:', event);
        });

        // VIEWER events

        // EDITING MODE - create a new marker when the user clicks somewhere
        let selectedMarker = null;

        viewer.addEventListener('click', ({ data }) => {
            
            if (isEditingMode && data.rightclick) {
                // RIGHT CLICKED on empty space so DESELECT any previous edit marker 
                if( selectedMarker ) {
                    markersPlugin.updateMarker({
                        id: selectedMarker.id,
                        image: baseUrl + 'pictos/pin-red.png',
                    });
                    selectedMarker = null;
                }

                // CREATE tooltip for new edit marker
                const tooltipHTML = loadNodeTooltip();

                // CREATE new edit marker
                console.log( "viewer click - new edit marker")
                const s = `${data.yaw} ${data.pitch}`;
                const mId = '#' + newMarkerId.toString();
                const newMarker = {
                    id: mId,
                    position: { yaw: data.yaw, pitch: data.pitch },
                    image: baseUrl + 'pictos/pin-blue.png',
                    size: { width: 32, height: 32 },
                    anchor: 'bottom center',
                    tooltip: {
                        content: tooltipHTML,   //document.querySelector('#tooltip-content-list').innerText,
                        className: 'custom-tooltip',
                        position: 'top',
                        trigger: 'click',
                    },
                    data: {
                        generated: true,
                    },
                };

                // SELECTED new edit marker
                selectedMarker = newMarker;
                newMarkerId += 1;
                const yawInDegrees = data.yaw * (180 / Math.PI);
                const pitchInDegrees = data.pitch * (180 / Math.PI);
                const viewerCoords = viewer.dataHelper.viewerCoordsToSphericalCoords({
                        x: data.clientX,
                        y: data.clientY
                });
                    
                markersPlugin.addMarker( newMarker );                

                // Update the editSummary text input with marker information
                const currentNode = virtualTourPlugin.getCurrentNode();
                const editSummary = document.getElementById('editSummary');
                editSummary.value = `{ node: \"${currentNode.id}\", pitch: ${newMarker.position.pitch}, yaw: ${newMarker.position.yaw}, targetNode: 1 },`;
            }
        
        });
        

        // MARKER events
        let tooltip = null
        
        markersPlugin.addEventListener('select-marker', ({ marker, click, doubleClick, rightClick }) => {

            if ( isEditingMode ) {
    
                // SELECTED edit marker so DESELECT previous edit marker
                if( selectedMarker == marker) {
                    console.log ('markers select-marker - same marker');
                }
                else {
                    if ( selectedMarker ) {
                        console.log('markers select-marker - SELECT', marker.id, marker.data );
                        markersPlugin.updateMarker({
                            id: selectedMarker.id,
                            image: baseUrl + 'pictos/pin-red.png', // back to DESELECTED
                            content: selectedMarker.id,
                        });
                        if (tooltip) {
                            tooltip.hide();
                            tooltip = null;
                        }
                    }
                    selectedMarker = marker;
                    markersPlugin.updateMarker({
                        id: selectedMarker.id,
                        image: baseUrl + 'pictos/pin-blue.png',
                        content: selectedMarker.id
                    });

                    // create tooltip
                    if (!tooltip) {
                        const tooltipHTML = loadNodeTooltip()
                        tooltip = viewer.createTooltip({
                            content: tooltipHTML, // document.getElementById( 'tooltip-content-list' ).outerHTML,
                            left: 900, // x,
                            top: 800, // y,
                            position: 'top right',
                            trigger: 'click',
                            visible: true,
                        });
                    }
                }
                
            }

            if (marker.data?.generated) {
                if (isEditingMode) {

                    const onMouseUp = () => {
                        console.log( "onMouseUp" );
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    const onMouseDown = () => {
                        console.log( "onMouseDown" );
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    };
                    document.addEventListener('mousedown', onMouseDown);
                }

                if (isEditingMode && doubleClick) {
                    markersPlugin.removeMarker(marker);
                } else if (isEditingMode && rightClick) {
                    console.log( "markers select-marker right click to SELECTED");
                    selectedMarker = marker
                    markersPlugin.updateMarker({
                        id: marker.id,
                        image: baseUrl + 'pictos/pin-blue.png',
                    });
                    //const currentNode = virtualTourPlugin.getCurrentNode();
                    //console.log( currentNode.id, marker.config.position.yaw, marker)
                }
            }
            
            if( !isEditingMode && !doubleClick ) {
                console.log( "Navigate:" + marker.id + " -> " + marker.data.targetNode );
                if ( marker.data.targetNode ) {
                    virtualTourPlugin.setCurrentNode( marker.data.targetNode );
                }
            }
        });


        // generate HTML for tooltip listbox of all possible nodes
        function loadNodeTooltip() {
            const optionValues = configData[0].nodes.map(node => node.id);
            let selectElement = document.getElementById('tooltip-content-list'); // Dynamic list of node names
            if( !selectElement ) {
                console.log( "no tooltip-content-list in HTML" );
                selectElement = document.createElement('select');
                selectElement.id = 'tooltip-content-list';
                selectElement.name = 'options';
                selectElement.size = 10; 
            }
            else {
                selectElement.innerHTML = "";
            }

            optionValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });

            console.log( "tooltip-content-list", selectElement.outerHTML );
            return selectElement.outerHTML;
        }

        ///
        // Subroutine to export configData to a JSON file and download it
        function saveConfigData() {
            const formattedConfigData = configData.map(section => {
                return {
                    id: section.id,
                    nodes: section.nodes.map(node => ({
                        id: node.id,
                        image: node.image
                    })),
                    hotspots: section.hotspots.map(hotspot => ({
                        node: hotspot.node,
                        pitch: hotspot.pitch,
                        yaw: hotspot.yaw,
                        targetNode: hotspot.targetNode
                    }))
                };
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(formattedConfigData),null,"4");
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "360tour.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }



        // Add event listener to export button
        document.getElementById('exportButton').addEventListener('click', () => {
            //const json = JSON.stringify(floorGarden, null, 2);
            const json = JSON.stringify(floorGarden );
            console.log(json);
        });

        // Add event listener to export button
        document.getElementById('exportHotspots').addEventListener('click', () => {
            const currentNode = virtualTourPlugin.getCurrentNode();
            const ms = markersPlugin.getMarkers();
            var index = 1
            ms.forEach( m => {
                console.log(`{ node: \"${currentNode.id}\", pitch: ${m.config.position.pitch}, yaw: ${m.config.position.yaw}, targetNode: 1 },`);
                index += 1;
            });
        });

        let isEditingMode = false;

        // Add event listener to the checkbox
        document.getElementById('editMode').addEventListener('change', (event) => {
            isEditingMode = event.target.checked;
        });
    </script>


    <script type="text/template" id="xxxtooltip-content">
        <select id="xxxtooltip-content-list" name="options" size=10>
          <option value="option1">Option aa</option>
          <option value="option2">Option bn</option>
          <option value="option3">Option c</option>
          <option value="option4">Option d</option>
        </select>
    </script>


    <button id="exportButton">Export dynNode as JSON</button>
    <button id="exportHotspots">Export hotSpots</button>
    <label for="editMode">edit mode</label>
    <input type="checkbox" id="editMode">
    <input type="text" id="editSummary" style="width:800px" value="">

</body>
</html>
